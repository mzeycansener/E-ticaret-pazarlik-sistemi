<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Butik Karar Destek Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        <h1 class="text-2xl font-bold mb-4 text-center text-indigo-600">Butik Mağaza Paneli</h1>

        <div class="mb-6 p-4 bg-yellow-50 rounded border border-yellow-200">
            <label class="block text-gray-700 font-bold mb-2">Hangi Müşteriyle Test Edeceksin?</label>
            <select id="userSelect" class="w-full p-2 border rounded">
                <option value="11111111-1111-1111-1111-111111111111">Demir Üye (Standart)</option>
                <option value="22222222-2222-2222-2222-222222222222">Altın Üye (VIP)</option>
            </select>
        </div>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Sepet Özeti</h2>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                <span>Vintage Deri Ceket (x1)</span>
                <span class="font-bold">2000 TL</span>
            </div>
            
            <button onclick="calculatePrice()" class="mt-4 w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                Fiyatı Hesapla & İndirimi Gör
            </button>
        </div>

        <div id="resultArea" class="hidden mt-4 p-4 border rounded bg-green-50 border-green-200">
            <p><strong>Müşteri Tipi:</strong> <span id="tierDisplay">-</span></p>
            <p><strong>İndirim Oranı:</strong> %<span id="discountDisplay">-</span></p>
            <p class="text-xl mt-2"><strong>Son Fiyat: <span id="finalPriceDisplay" class="text-green-700">-</span> TL</strong></p>
            
            <div id="bargainSection" class="hidden mt-4 border-t pt-4">
                <p class="text-yellow-700 font-bold text-sm mb-2">✨ Altın Üye Ayrıcalığı: Pazarlık Yapabilirsin!</p>
                <input type="number" id="offerInput" placeholder="Teklifin nedir?" class="w-full p-2 border rounded mb-2">
                <button onclick="makeOffer()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                    Teklifi Gönder
                </button>
                <p id="bargainMsg" class="text-center text-sm mt-2 text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        // --- FONKSIYON 1: FİYAT HESAPLA ---
        async function calculatePrice() {
            const userId = document.getElementById('userSelect').value;
            const cartTotal = 2000;
            const resultArea = document.getElementById('resultArea');

            try {
                console.log("İstek gönderiliyor -> User:", userId);
                
                const response = await fetch('/api/cart/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId, cartTotal })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Sunucu Hatası: ${errText}`);
                }

                const data = await response.json();
                console.log("Cevap geldi:", data);

                // Sonuçları Ekrana Yazdırcan
                resultArea.classList.remove('hidden');
                document.getElementById('tierDisplay').innerText = data.tier ? data.tier.toUpperCase() : "HATA";
                document.getElementById('discountDisplay').innerText = data.discountRate * 100;
                document.getElementById('finalPriceDisplay').innerText = data.finalPrice;

                // Pazarlık butonu calısıyomu
                const bargainSec = document.getElementById('bargainSection');
                if (data.canBargain) {
                    bargainSec.classList.remove('hidden');
                } else {
                    bargainSec.classList.add('hidden');
                }

            } catch (error) {
                alert("HATA OLUŞTU: " + error.message);
                console.error(error);
            }
        }

        // --- FONKSIYON 2: PAZARLIK TEKLİFİ YAP ---
        async function makeOffer() {
            const userId = document.getElementById('userSelect').value;
            const offerAmount = document.getElementById('offerInput').value; // <-- offerAmount SADECE BURADA OLMALI
            const msgBox = document.getElementById('bargainMsg');

            if(!offerAmount) return alert("Lütfen bir tutar girin!");

            try {
                msgBox.innerText = "Yöneticiye soruluyor...";
                
                const response = await fetch('/api/bargain/request', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        userId, 
                        cartId: 1, 
                        productId: 1, // Ürün ID'si (Önemli!)
                        originalPrice: 2000, 
                        offeredPrice: offerAmount 
                    })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                
                msgBox.innerText = "✅ " + data.message;
                
            } catch (err) {
                msgBox.innerText = "❌ Hata: " + err.message;
            }
        }
    </script>
</body>
</html>